<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WhatsApp Blaster v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Mencegah highlight biru saat elemen disentuh di mobile */
        * { -webkit-tap-highlight-color: transparent; }

        /* TEKNIK CSS UNTUK MENGUBAH TABEL MENJADI KARTU DI MOBILE */
        @media (max-width: 767px) {
            #desktop-table thead {
                display: none;
            }
            #desktop-table tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: 0.75rem;
                border: 1px solid #e5e7eb;
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                background: white;
            }
            #desktop-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.8rem 1rem;
                border-bottom: 1px solid #f3f4f6;
            }
            #desktop-table td:last-child {
                border-bottom: none;
                background-color: #f9fafb;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            #desktop-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
                font-size: 0.875rem;
            }
            #desktop-table .action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: flex-end;
                flex-grow: 1;
            }
            #desktop-table .action-buttons button {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-24 sm:pb-4">

    <div id="toast" class="fixed top-5 right-5 z-50 hidden max-w-sm">
        <div class="flex items-center p-4 rounded-lg shadow-lg bg-white border-l-4">
            <i id="toast-icon"></i>
            <span id="toast-message" class="ml-3 text-sm font-medium"></span>
        </div>
    </div>

    <div class="container mx-auto max-w-7xl px-2 sm:px-4 py-4">
        <div class="sm:hidden flex bg-white rounded-lg shadow-sm p-1 mb-4">
            <button id="template-tab-btn" class="flex-1 py-2 px-3 text-sm font-semibold rounded-md bg-blue-600 text-white transition-all duration-300"><i class="fas fa-edit mr-2"></i>Template</button>
            <button id="recipient-tab-btn" class="flex-1 py-2 px-3 text-sm font-semibold rounded-md text-gray-600 transition-all duration-300"><i class="fas fa-users mr-2"></i>Penerima</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="template-section" class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-5 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Template Pesan</h2>
                    <textarea id="message-template" rows="10" class="w-full text-sm p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Assalamualaikum, kami mengundang Bapak/Ibu wali dari [[Nama_Siswa]]..."></textarea>
                    <div class="text-xs text-gray-500 mt-2 mb-4">Variabel: [[Nama_Siswa]], [[NIS]]</div>
                    <div class="flex justify-end gap-3">
                        <button id="preview-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-semibold rounded-lg hover:bg-gray-300"><i class="fas fa-eye mr-2"></i>Preview</button>
                        <button id="save-template-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700"><i class="fas fa-save mr-2"></i>Simpan</button>
                    </div>
                </div>
            </div>

            <div id="recipient-section" class="lg:col-span-2 hidden sm:block">
                <div class="bg-white rounded-xl shadow-md">
                    <div class="p-5 border-b">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Daftar Penerima</h2>
                        <input type="text" id="searchInput" class="w-full text-sm border rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="Cari nama atau NIS...">
                    </div>
                    <div class="p-5 hidden sm:flex justify-between items-center border-b">
                        <div class="flex items-center">
                            <input type="checkbox" id="selectAllHeader" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-0 mr-2">
                            <label for="selectAllHeader" class="text-sm">Pilih Semua yang Tampil</label>
                        </div>
                        <button id="bulk-send-btn" class="px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600 disabled:opacity-50" disabled><i class="fas fa-paper-plane mr-2"></i>Kirim Massal</button>
                    </div>
                    
                    <div id="status-message" class="text-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-sm text-gray-500">Memuat data...</p></div>
                    <div id="data-container" class="hidden">
                        <table id="desktop-table" class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4"></th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Siswa</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden text-center p-10"><i class="fas fa-search text-4xl text-gray-300"></i><p class="mt-4 text-sm text-gray-500">Data tidak ditemukan.</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-action-bar" class="sm:hidden fixed bottom-0 left-0 right-0 bg-white p-3 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] flex justify-between items-center">
        <div class="flex items-center">
            <input type="checkbox" id="selectAllFooter" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-0 mr-2">
            <label for="selectAllFooter" class="text-sm">Pilih Semua</label>
        </div>
        <button id="mobile-bulk-send-btn" class="px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600 disabled:opacity-50" disabled><i class="fas fa-paper-plane mr-2"></i>Kirim</button>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">Pratinjau Pesan</h3>
                <button id="close-preview-btn" class="text-gray-400 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-5 max-h-96 overflow-y-auto"><pre id="preview-content" class="whitespace-pre-wrap font-sans text-sm"></pre></div>
            <div class="p-4 bg-gray-50 flex justify-end"><button id="close-preview-btn-2" class="px-4 py-2 bg-gray-200 text-sm font-semibold rounded-lg">Tutup</button></div>
        </div>
    </div>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbz3nCIRHCMaUQy6LJcF6eZoD8TiQmJIVFsAygGRgHyxGwnDrKsOb5z_6Y96N0XHgyCNxw/exec';
        let fetchedData = [], filteredData = [], selectedIndices = new Set();
        
        const dom = {
            templateSection: document.getElementById('template-section'),
            recipientSection: document.getElementById('recipient-section'),
            templateTabBtn: document.getElementById('template-tab-btn'),
            recipientTabBtn: document.getElementById('recipient-tab-btn'),
            dataTableBody: document.getElementById('dataTableBody'),
            searchInput: document.getElementById('searchInput'),
            selectAllHeader: document.getElementById('selectAllHeader'),
            selectAllFooter: document.getElementById('selectAllFooter'),
            bulkSendBtn: document.getElementById('bulk-send-btn'),
            mobileBulkSendBtn: document.getElementById('mobile-bulk-send-btn'),
            statusMessage: document.getElementById('status-message'),
            dataContainer: document.getElementById('data-container'),
            emptyState: document.getElementById('emptyState'),
            messageTemplate: document.getElementById('message-template'),
            previewModal: document.getElementById('preview-modal'),
            previewContent: document.getElementById('preview-content'),
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadTemplate();
            setupEventListeners();
        });

        function setupEventListeners() {
            dom.searchInput.addEventListener('input', filterAndRender);
            dom.templateTabBtn.addEventListener('click', () => switchTab('template'));
            dom.recipientTabBtn.addEventListener('click', () => switchTab('recipient'));
            dom.selectAllHeader.addEventListener('change', (e) => toggleSelectAll(e.target.checked));
            dom.selectAllFooter.addEventListener('change', (e) => toggleSelectAll(e.target.checked));
            dom.bulkSendBtn.addEventListener('click', sendBulkMessages);
            dom.mobileBulkSendBtn.addEventListener('click', sendBulkMessages);
            document.getElementById('save-template-btn').addEventListener('click', saveTemplate);
            document.getElementById('preview-btn').addEventListener('click', showPreview);
            document.getElementById('close-preview-btn').addEventListener('click', () => dom.previewModal.classList.add('hidden'));
            document.getElementById('close-preview-btn-2').addEventListener('click', () => dom.previewModal.classList.add('hidden'));
            
            dom.dataTableBody.addEventListener('click', e => {
                if (e.target.closest('.send-btn')) sendMessage(e.target.closest('.send-btn'));
            });

            dom.dataTableBody.addEventListener('change', e => {
                if (e.target.classList.contains('student-checkbox')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    e.target.checked ? selectedIndices.add(index) : selectedIndices.delete(index);
                    updateUI();
                }
            });
        }
        
        function switchTab(tabName) {
            const isTemplate = tabName === 'template';
            dom.templateSection.classList.toggle('hidden', !isTemplate);
            dom.recipientSection.classList.toggle('hidden', isTemplate);
            dom.templateTabBtn.classList.toggle('bg-blue-600', isTemplate);
            dom.templateTabBtn.classList.toggle('text-white', isTemplate);
            dom.recipientTabBtn.classList.toggle('bg-blue-600', !isTemplate);
            dom.recipientTabBtn.classList.toggle('text-white', !isTemplate);
        }

        async function loadData() {
            try {
                const response = await fetch(webAppUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                fetchedData = await response.json();
                dom.statusMessage.classList.add('hidden');
                dom.dataContainer.classList.remove('hidden');
                filterAndRender();
            } catch (error) {
                dom.statusMessage.innerHTML = 'Gagal memuat data. Periksa URL atau koneksi.';
            }
        }

        function filterAndRender() {
            const term = dom.searchInput.value.toLowerCase();
            filteredData = fetchedData.filter(item => 
                item.Nama_Siswa?.toLowerCase().includes(term) || item.NIS?.toString().includes(term)
            );
            renderTable();
            updateUI();
        }

        function renderTable() {
            dom.emptyState.classList.toggle('hidden', filteredData.length > 0);
            dom.dataTableBody.innerHTML = filteredData.map(item => {
                const originalIndex = fetchedData.indexOf(item);
                const isSelected = selectedIndices.has(originalIndex);
                let actionsHTML = '<div class="action-buttons">';
                if(item.WA_Siswa) actionsHTML += `<button class="send-btn flex-1 px-3 py-2 text-xs font-semibold bg-green-100 text-green-700 rounded-md" data-phone="${item.WA_Siswa}"><i class="fab fa-whatsapp mr-1"></i>Siswa</button>`;
                if(item.WA_Ayah) actionsHTML += `<button class="send-btn flex-1 px-3 py-2 text-xs font-semibold bg-blue-100 text-blue-700 rounded-md" data-phone="${item.WA_Ayah}"><i class="fab fa-whatsapp mr-1"></i>Ayah</button>`;
                if(item.WA_Ibu) actionsHTML += `<button class="send-btn flex-1 px-3 py-2 text-xs font-semibold bg-purple-100 text-purple-700 rounded-md" data-phone="${item.WA_Ibu}"><i class="fab fa-whatsapp mr-1"></i>Ibu</button>`;
                actionsHTML += '</div>';

                return `
                    <tr class="${isSelected ? 'bg-blue-50' : ''}">
                        <td data-label="Pilih" class="p-4"><input type="checkbox" class="student-checkbox h-4 w-4" data-index="${originalIndex}" ${isSelected ? 'checked' : ''}></td>
                        <td data-label="Siswa" class="p-4"><div class="font-bold text-gray-800">${item.Nama_Siswa}</div><div class="text-xs text-gray-500">NIS: ${item.NIS}</div></td>
                        <td data-label="Aksi" class="p-4">${actionsHTML}</td>
                    </tr>`;
            }).join('');
        }
        
        function updateUI() {
            const allVisibleSelected = filteredData.length > 0 && filteredData.every(item => selectedIndices.has(fetchedData.indexOf(item)));
            dom.selectAllHeader.checked = allVisibleSelected;
            dom.selectAllFooter.checked = allVisibleSelected;
            
            const canSend = selectedIndices.size > 0;
            [dom.bulkSendBtn, dom.mobileBulkSendBtn].forEach(btn => {
                btn.disabled = !canSend;
                const baseText = btn.id === 'bulk-send-btn' ? 'Kirim Massal' : 'Kirim';
                btn.innerHTML = canSend ? `<i class="fas fa-paper-plane mr-2"></i>${baseText} (${selectedIndices.size})` : `<i class="fas fa-paper-plane mr-2"></i>${baseText}`;
            });
        }
        
        function toggleSelectAll(isChecked) {
            filteredData.forEach(item => {
                const originalIndex = fetchedData.indexOf(item);
                isChecked ? selectedIndices.add(originalIndex) : selectedIndices.delete(originalIndex);
            });
            renderTable();
            updateUI();
        }

        function sendMessage(btn) {
            const template = dom.messageTemplate.value;
            if (!template) return showToast('Template pesan tidak boleh kosong.', 'error');
            const phone = btn.dataset.phone;
            const tr = btn.closest('tr');
            const studentIndex = parseInt(tr.querySelector('.student-checkbox').dataset.index, 10);
            const studentData = fetchedData[studentIndex];
            const finalMessage = replaceTemplateVariables(template, studentData);
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(finalMessage)}`, '_blank');
        }

        function sendBulkMessages() {
            const template = dom.messageTemplate.value;
            if (!template) return showToast('Template pesan tidak boleh kosong.', 'error');
            if (confirm(`Anda akan membuka WhatsApp untuk ${selectedIndices.size} penerima. Lanjutkan?`)) {
                selectedIndices.forEach(index => {
                    const studentData = fetchedData[index];
                    const phone = studentData.WA_Siswa || studentData.WA_Ayah || studentData.WA_Ibu;
                    if (phone) {
                        const finalMessage = replaceTemplateVariables(template, studentData);
                        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(finalMessage)}`, '_blank');
                    }
                });
            }
        }
        
        function replaceTemplateVariables(template, data) {
            return template.replace(/\[\[(.*?)\]\]/g, (match, key) => data[key.trim()] || '-');
        }

        function saveTemplate() {
            localStorage.setItem('whatsappTemplate', dom.messageTemplate.value);
            showToast('Template berhasil disimpan.', 'success');
        }

        function loadTemplate() {
            dom.messageTemplate.value = localStorage.getItem('whatsappTemplate') || '';
        }

        function showPreview() {
            const template = dom.messageTemplate.value;
            if (!template) return showToast('Isi template untuk melihat pratinjau.', 'error');
            const studentData = fetchedData[0] || {Nama_Siswa: 'John Doe', NIS: '12345'};
            dom.previewContent.textContent = replaceTemplateVariables(template, studentData);
            dom.previewModal.classList.remove('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');
            toast.style.borderLeftColor = type === 'success' ? '#22c55e' : '#ef4444';
            toastIcon.className = type === 'success' ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500';
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
